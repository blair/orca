#!/bin/sh

# This script runs orcallator.se with the proper options for your site.

# Define program locations that will be needed.
prefix=@prefix@
exec_prefix=@exec_prefix@
libdir=@libdir@
AWK=@AWK@
COMPRESSOR="@COMPRESSOR@"
CUT=@CUT@
EXPR=@EXPR@
UNAME=@UNAME@
ORCALLATOR_DIR=@ORCALLATOR_DIR@
SE=@SE@
WATCH_WEB="@WATCH_WEB@"
WEB_LOG=@WEB_LOG@

# Check if the SE executable was found upon configure.
if test -z "$SE"; then
  echo "When you configured Orca the se executable was not found.  If you"
  echo "do not have the SE toolkit installed on your system, then follow"
  echo "the steps in section 8 of INSTALL."
  echo ""
  echo "Once you have the SE toolkit installed on your system, then either"
  echo "rerun configure so that it finds se, or edit start_orcallator.sh"
  echo "and define SE to the location of se."
  exit 1
fi

if test ! -x "$SE"; then
  echo "The SE executable at"
  echo "  $SE"
  echo "does not exist or is not executable.  Please correct this problem."
  exit 1
fi

# Get the hostname without the fully qualified part; that is, trim off
# anything past the first `.'.
uname=`$UNAME -n | $CUT -d. -f1`

# The directory these files go into is $ORCALLATOR_DIR/HOSTNAME
OUTDIR=$ORCALLATOR_DIR/$uname

# Export the environmental variables.
export COMPRESSOR OUTDIR WEB_LOG

# Check if orcallator is already running.
pids=`/usr/ucb/ps auxww | $AWK '/orcallator.se/ && !/awk/ {print $2}'`
if test "$pids" != ""; then
  echo "Orcallator already running.  Exiting."
  exit 1
fi

echo "Writing data into $OUTDIR/"
if test "$WEB_LOG"; then
  echo "Using www access log file $WEB_LOG"
fi

# Cd to / so that any automounted filesystems can be unmounted.
cd /

# Create the output directory if it doesn't exist yet.
if test ! -d $OUTDIR; then
  echo "Creating $OUTDIR/"
  mkdir -p $OUTDIR
fi

if test ! -d $OUTDIR; then
  echo "Unable to create $OUTDIR/" 1>&2
  exit 2
fi

# Now start the logging.
echo "Starting logging"
$SE $LE_PATCH -DWATCH_OS $WATCH_WEB $libdir/orcallator.se &

# Write the PID of orcallator to a file to make killing easier.
pid=$!
echo $pid > $OUTDIR/orcallator.pid

# Sleep for a couple of seconds to allow any orcallator warnings to appear.
sleep 5
