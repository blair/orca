#!/bin/sh

# This script runs percollator.se with the proper options for your site.

# Define program locations that will be needed.
prefix=@prefix@
exec_prefix=@exec_prefix@
libdir=@libdir@
AWK=@AWK@
CUT=@CUT@
EXPR=@EXPR@
UNAME=@UNAME@
NCSAHTTPLOG=@NCSAHTTPLOG@
PERCOLLATOR_DIR=@PERCOLLATOR_DIR@
SE=@SE@

# Get the hostname without the fully qualified part; that is, trim off
# anything past the first `.'.
uname=`$UNAME -n | $CUT -d. -f1`

# The directory these files go into is $PERCOLLATOR_DIR/HOSTNAME
OUTDIR=$PERCOLLATOR_DIR/$uname

# Export the environmental variables.
export NCSAHTTPLOG OUTDIR

# Check if percollator is already running.
pids=`/usr/ucb/ps auxww | $AWK '/percollator.se/ && !/awk/ {print $2}'`
if test "$pids" != ""; then
  echo "Percollator already running.  Exiting."
  exit 1
fi

echo "Writing data into $OUTDIR/"
echo "Using www access log file $NCSAHTTPLOG"

# Cd to / so that any automounted filesystems can be unmounted.
cd /

# Create the output directory if it doesn't exist yet.
if test ! -d $OUTDIR; then
  echo "Creating $OUTDIR/"
  mkdir -p $OUTDIR
fi

if test ! -d $OUTDIR; then
  echo "Unable to create $OUTDIR/" 1>&2
  exit 2
fi

# Only turn on HTTP recording if NCSAHTTPLOG is set.
WATCH_HTTPD=
if test "$NCSAHTTPLOG"; then
  WATCH_HTTPD=-DWATCH_HTTPD
fi

# Now start the logging.
echo "Starting logging"
$SE $LE_PATCH -DWATCH_OS $WATCH_HTTPD $libdir/percollator.se &

# Write the PID of percollator to a file to make killing easier.
pid=$!
echo $pid > $OUTDIR/percollator.pid

# Sleep for a couple of seconds to allow any percollator warnings to appear.
sleep 5
