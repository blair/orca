#!/bin/sh

# This script runs Orca_Services with the proper options for your site.

# Define program locations that will be needed.
prefix=@prefix@
exec_prefix=@exec_prefix@
libdir=@libexecdir@
AWK=@AWK@
CUT=@CUT@
UNAME=@UNAME@
ORCA_SERVICES_DIR=@VAR_DIR@/Orca_Services

# Get the hostname without the fully qualified part; that is, trim off
# anything past the first `.'.
uname=`$UNAME -n | $CUT -d. -f1`

OPERSYS=`$UNAME -s`
if test "${OPERSYS}" = "Linux"; then
    PSCMD="/bin/ps auxww"
else
    PSCMD="/usr/bin/ps -ef" # Solaris
fi

# The directory these files go into is $ORCA_SERVICES_DIR/HOSTNAME
OUTDIR=$ORCA_SERVICES_DIR/$uname

# Export the environmental variables.
export OUTDIR

# Check if Orca_Services is already running.
pids=`$PSCMD | $AWK '/Orca_Services/ && !/awk/ && !/start_Orca_Services/ && !/daemon/ && !/ \/etc\/init\.d/ && !/ \/etc\/rc/ {print $2}'`
if test "$pids" != ""; then
  echo "Orca_Services already running.  Exiting."
  exit 1
fi

echo "Writing data into $OUTDIR/"

# Cd to / so that any automounted filesystems can be unmounted.
cd /

# Create the output directory if it doesn't exist yet.
if test ! -d $OUTDIR; then
  echo "Creating $OUTDIR/"
  mkdir -p $OUTDIR
fi

if test ! -d $OUTDIR; then
  echo "Unable to create $OUTDIR/" 1>&2
  exit 2
fi

# Now start the logging.
echo "Starting logging"
HOSTNAME=`hostname`
if test -f "$libdir/Orca_Services.$HOSTNAME"; then
    $libdir/Orca_Services `cat $libdir/Orca_Services.$HOSTNAME`
else
    $libdir/Orca_Services
fi

### # Write the PID of Orca_Services to a file to make killing easier.
### pid=$!
### echo $pid > $OUTDIR/Orca_Services.pid

# Sleep for a couple of seconds to allow any Orca_Services warnings to appear.
sleep 5
