@SET_MAKE@

prefix            = @prefix@
MKDIR             = @MKDIR@
CFLAGS            = @CFLAGS@

SUBDIRS           = packages \
                    lib \
                    orca \
                    data_gatherers \
                    docs \
                    contrib

all: configure config/PerlHead1 config/PerlHead2 Makefile
	@for dir in $(SUBDIRS); do \
	  if test -d $$dir; then \
	    echo "cd $$dir"; \
	    cd $$dir || exit 1; \
	    echo "$(MAKE) CFLAGS=$(CFLAGS) || exit 1"; \
	    $(MAKE) CFLAGS="$(CFLAGS)" || exit 1; \
	    echo "cd .."; \
	    cd ..; \
	  else \
	    exit 1; \
	  fi \
	done

test: configure Makefile

upgrade:
	cd src && $(MAKE) upgrade_installation

install:
	@for dir in $(SUBDIRS); do \
	  if test -d $$dir; then \
	    echo "cd $$dir"; \
	    cd $$dir || exit 1; \
	    echo "$(MAKE) CFLAGS=$(CFLAGS) install || exit 1"; \
	    $(MAKE) CFLAGS="$(CFLAGS)" install || exit 1; \
	    echo "cd .."; \
	    cd ..; \
	  else \
	    exit 1; \
	  fi \
	done

install_contrib:
	cd contrib && $(MAKE) install_contrib

orcallator_run_at_boot:
	cd data_gatherers/orcallator && $(MAKE) orcallator_run_at_boot

orca_services_run_at_boot:
	cd data_gatherers/orca_services && $(MAKE) orca_services_run_at_boot

procallator_run_at_boot:
	cd data_gatherers/procallator && $(MAKE) procallator_run_at_boot

test_modules:
	cd packages && $(MAKE) CFLAGS="$(CFLAGS)" test_modules

install_modules:
	cd packages && $(MAKE) CFLAGS="$(CFLAGS)" install_modules

clean:
	@for dir in $(SUBDIRS); do \
	  echo "cd $$dir && $(MAKE) clean"; \
	  (cd $$dir && $(MAKE) clean); \
	done

distclean:
	@for dir in $(SUBDIRS); do \
	  echo "cd $$dir && $(MAKE) distclean"; \
	  (cd $$dir && $(MAKE) distclean); \
	done
	$(RM) -r autom4te*.cache
	$(RM) config/aclocal.m4 config/PerlHead1 config/PerlHead2
	$(RM) configure config.cache config.log config.status Makefile

to-autoconf:
	aclocal -I config --output=config/aclocal.m4
	autoconf --include=config
	$(RM) -r autom4te.cache

configure: configure.in
	$(MAKE) to-autoconf
	./config.status

Makefile: Makefile.in
	CONFIG_FILES=Makefile ./config.status

config/PerlHead1: config/PerlHead1.in
	CONFIG_FILES=config/PerlHead1 ./config.status

config/PerlHead2: config/PerlHead2.in
	CONFIG_FILES=config/PerlHead2 ./config.status
