@SET_MAKE@

SUBDIRS 	= packages lib src @ORCALLATOR_SUBDIR@ docs contrib
prefix		= @prefix@
MKDIR		= @MKDIR@
MAKE_RRDTOOL	= @MAKE_RRDTOOL@
ORCALLATOR_DIR	= @ORCALLATOR_DIR@
RRD_DIR		= @RRD_DIR@
CFLAGS		= @CFLAGS@

all:	configure config/PerlHead1 config/PerlHead2 Makefile
	@for dir in $(SUBDIRS); do					\
		echo "cd $$dir && $(MAKE) CFLAGS=$(CFLAGS)";		\
		(cd $$dir && $(MAKE) CFLAGS="$(CFLAGS)");		\
	done

test:	configure Makefile

upgrade:
	cd src && $(MAKE) upgrade_installation

install: $(INSTALL_RRDTOOL)
	$(MKDIR) $(ORCALLATOR_DIR)
	$(MKDIR) $(RRD_DIR)/orcallator
	@for dir in $(SUBDIRS); do			\
		echo "cd $$dir && $(MAKE) install";	\
		(cd $$dir && $(MAKE) install);		\
	done

install_contrib:
	cd contrib && $(MAKE) install_contrib

orcallator_run_at_boot:
	cd orcallator && $(MAKE) orcallator_run_at_boot

test_modules:
	cd packages && $(MAKE) CFLAGS="$(CFLAGS)" test_modules

install_modules:
	cd packages && $(MAKE) CFLAGS="$(CFLAGS)" install_modules

clean:	$(CLEAN_RRDTOOL)
	@for dir in $(SUBDIRS); do			\
		echo "cd $$dir && $(MAKE) clean";	\
		(cd $$dir && $(MAKE) clean);		\
	done

distclean: $(DISTCLEAN_RRDTOOL)
	@for dir in $(SUBDIRS); do			\
		echo "cd $$dir && $(MAKE) distclean";	\
		(cd $$dir && $(MAKE) distclean);	\
	done
	$(RM) config/PerlHead1 config/PerlHead2
	$(RM) config.cache config.log config.status Makefile

to-autoconf:
	aclocal -I config --output=config/aclocal.m4 && autoconf --localdir=config

configure: configure.in
	$(MAKE) to-autoconf
	./config.status

Makefile: Makefile.in
	CONFIG_FILES=Makefile ./config.status

config/PerlHead1: config/PerlHead1.in
	CONFIG_FILES=config/PerlHead1 ./config.status

config/PerlHead2: config/PerlHead2.in
	CONFIG_FILES=config/PerlHead2 ./config.status
